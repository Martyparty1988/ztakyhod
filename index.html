<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Najdi smažák v17.4 - Vylepšená Detekce</title>
    
    <script>
        (function() {
            function drawIcon(size) {
                const canvas = document.createElement('canvas'); canvas.width = size; canvas.height = size; const ctx = canvas.getContext('2d'); const scale = size / 512; ctx.fillStyle = '#0a192f'; ctx.fillRect(0, 0, size, size); ctx.save(); ctx.translate(size / 2, size / 2); const bagWidth = 280 * scale; const bagHeight = 320 * scale; ctx.beginPath(); ctx.moveTo(-bagWidth / 2, -bagHeight / 2 + 50 * scale); ctx.lineTo(-bagWidth / 2, bagHeight / 2); ctx.quadraticCurveTo(0, bagHeight / 2 + 40 * scale, bagWidth / 2, bagHeight / 2); ctx.lineTo(bagWidth / 2, -bagHeight / 2 + 50 * scale); ctx.closePath(); ctx.fillStyle = 'rgba(230, 240, 255, 0.15)'; ctx.strokeStyle = 'rgba(150, 180, 220, 0.4)'; ctx.lineWidth = 6 * scale; ctx.fill(); ctx.stroke(); ctx.beginPath(); ctx.moveTo(-bagWidth / 2 * 0.8, bagHeight / 2); ctx.quadraticCurveTo(-bagWidth / 2 * 0.5, bagHeight / 2 - 100 * scale, 0, bagHeight / 2 - 50 * scale); ctx.quadraticCurveTo(bagWidth / 2 * 0.5, bagHeight / 2 - 100 * scale, bagWidth / 2 * 0.8, bagHeight / 2); ctx.closePath(); ctx.fillStyle = 'rgba(255, 255, 255, 0.8)'; ctx.shadowColor = 'rgba(255, 255, 255, 0.7)'; ctx.shadowBlur = 20 * scale; ctx.fill(); ctx.shadowBlur = 0; ctx.fillStyle = 'rgba(20, 30, 50, 0.5)'; ctx.fillRect(-bagWidth/2 - 10*scale, -bagHeight/2 + 40*scale, bagWidth + 20*scale, 20*scale); ctx.strokeStyle = 'rgba(150, 180, 220, 0.6)'; ctx.strokeRect(-bagWidth/2 - 10*scale, -bagHeight/2 + 40*scale, bagWidth + 20*scale, 20*scale); ctx.beginPath(); ctx.moveTo(-40 * scale, -bagHeight / 2 + 40 * scale); ctx.quadraticCurveTo(0, -bagHeight/2 - 30 * scale, 40 * scale, -bagHeight/2 + 40 * scale); ctx.strokeStyle = '#facc15'; ctx.lineWidth = 10 * scale; ctx.stroke(); ctx.restore(); return canvas.toDataURL('image/png');
            }
            const icon192 = drawIcon(192), icon512 = drawIcon(512), favicon = drawIcon(32), themeColor = '#0a192f'; const manifest = { name: "Najdi smažák v17.4", short_name: "Smažák", start_url: ".", display: "standalone", background_color: themeColor, theme_color: themeColor, icons: [{ src: icon192, type: "image/png", sizes: "192x192" }, { src: icon512, type: "image/png", sizes: "512x512" }] }; const blob = new Blob([JSON.stringify(manifest)], { type: 'application/json' }); const manifestURL = URL.createObjectURL(blob); document.head.insertAdjacentHTML('beforeend', `<link rel="icon" href="${favicon}"><link rel="apple-touch-icon" href="${icon192}"><link rel="manifest" href="${manifestURL}"><meta name="theme-color" content="${themeColor}"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">`);
        })();
    </script>

    <script async src="https://unpkg.com/es-module-shims@1.6.3/dist/es-module-shims.js"></script>
    <script type="importmap">
    {
        "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.150.1/build/three.module.js",
            "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.150.1/examples/jsm/"
        }
    }
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-color: #0a192f; --accent-cyan: #07f5f5; --accent-purple: #c355f7; --accent-yellow: #fde047;
            --accent-red: #f43f5e; --accent-white: #e2e8f0; --accent-green: #4ade80; --text-primary: #e2e8f0; --text-secondary: #94a3b8;
            --glass-bg: rgba(15, 23, 42, 0.7); --glass-border: rgba(51, 65, 85, 0.5);
            --glow-cyan: rgba(7, 245, 245, 0.5); --glow-red: rgba(244, 63, 94, 0.5); --glow-white: rgba(226, 232, 240, 0.5); --glow-yellow: rgba(253, 224, 71, 0.5); --glow-purple: rgba(195, 85, 247, 0.5);
            --safe-area-top: env(safe-area-inset-top, 0px); --safe-area-bottom: env(safe-area-inset-bottom, 0px);
            --safe-area-left: env(safe-area-inset-left, 0px); --safe-area-right: env(safe-area-inset-right, 0px);
        }
        .night-mode { --bg-color: #020617; --glass-bg: rgba(2, 6, 23, 0.6); --glass-border: rgba(71, 85, 105, 0.5); }
        html, body { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; touch-action: none; -webkit-tap-highlight-color: transparent; background-color: var(--bg-color); color: var(--text-primary); font-family: 'Share Tech Mono', monospace; transition: background-color 0.5s; }
        #webgl-canvas { position: fixed; top: 0; left: 0; z-index: 0; }
        #root { position: fixed; inset: 0; z-index: 1; display: flex; align-items: center; justify-content: center; }
        #stage { position: relative; width: 360px; height: 640px; transform-origin: center center; overflow: hidden; display: flex; flex-direction: column; padding: var(--safe-area-top) var(--safe-area-right) var(--safe-area-bottom) var(--safe-area-left); }
        
        #stage::before { content: ''; position: absolute; inset: 0; z-index: 99; pointer-events: none; box-shadow: inset 0 0 100px 20px rgba(10, 25, 47, 0.8); background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADIAAAAyCAMAAAAp4XiDAAAAUVBMVEWFhYWDg4N3d3dtbW17e3t1dXVpaWl9fX1ZWVkICAgHBwdQUFBKSkpISEhHR0dISEhDQ0NERERGRkYAAAAAAAD///8EBAQAAAAAAAD///8fHx9aWloBAQG2S3bOAAAAAXRSTlMAQObYZgAAAAlwSFlzAAAOxAAADsQBlSsOGwAAAEBJREFUOI1jYBgFo2AUjIJRMApGwSigixrB+d9h56/58x8w8M9/4M8/YOB3+PNfMPA/fPif+fMfMPA/fPif+fM/AAC23wHlKULTiAAAAABJRU5ErkJggg=='); opacity: 0.05; }
        #stage::after { content: ''; position: absolute; inset: 0; z-index: 100; pointer-events: none; background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06)); background-size: 100% 4px, 3px 100%; animation: flicker 0.15s infinite; }
        @keyframes flicker { 0% { opacity: 0.2; } 20% { opacity: 0.8; } 40% { opacity: 0.3; } 60% { opacity: 0.9; } 80% { opacity: 0.2; } 100% { opacity: 0.8; } }
        @keyframes screen-shake { 0%, 100% { transform: translate(0, 0) rotate(0); } 10% { transform: translate(-1px, -2px) rotate(-0.5deg); } 30% { transform: translate(2px, 1px) rotate(0.5deg); } 50% { transform: translate(-1px, 2px) rotate(-0.2deg); } 70% { transform: translate(2px, 1px) rotate(0.2deg); } 90% { transform: translate(-1px, -1px) rotate(0); } }
        .is-shaking { animation: screen-shake 0.4s cubic-bezier(.36,.07,.19,.97) both; }
        @media (prefers-reduced-motion: reduce) { .is-shaking, #stage::after { animation: none; } }
        
        .font-orbitron { font-family: 'Orbitron', sans-serif; }
        .scene { position: absolute; inset: 0; display: flex; flex-direction: column; transition: opacity 0.4s ease, transform 0.4s ease; }
        .scene.hidden { opacity: 0; transform: scale(0.98); pointer-events: none; }
        #hud { display: grid; grid-template-columns: 1fr auto 1fr; align-items: center; padding: 12px; z-index: 10; gap: 8px; }
        .hud-pill { background: var(--glass-bg); border: 1px solid var(--glass-border); padding: 4px 8px; border-radius: 99px; font-size: 12px; text-shadow: 0 0 5px var(--glow-cyan); }
        .btn { font-family: 'Orbitron', sans-serif; font-weight: 700; padding: 16px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.2); color: var(--text-primary); text-transform: uppercase; letter-spacing: 1.5px; background: linear-gradient(45deg, rgba(7, 245, 245, 0.8), rgba(195, 85, 247, 0.8)); box-shadow: 0 0 20px 2px var(--glow-cyan), inset 0 0 5px rgba(255,255,255,0.5); transition: all 0.2s ease; text-shadow: 0 1px 2px rgba(0,0,0,0.4); }
        .btn:hover:not(:disabled) { box-shadow: 0 0 30px 5px var(--glow-purple), inset 0 0 10px rgba(255,255,255,0.5); transform: translateY(-2px); }
        .btn:active:not(:disabled) { transform: scale(0.97) translateY(1px); }
        .btn:disabled { filter: grayscale(80%) brightness(0.7); opacity: 0.6; cursor: not-allowed; box-shadow: none; }
        #toast-container { position: absolute; bottom: 20px; left: 20px; right: 20px; display: flex; flex-direction: column-reverse; gap: 8px; z-index: 40; pointer-events: none; }
        .toast { background: var(--glass-bg); backdrop-filter: blur(10px); padding: 10px 14px; border-radius: 12px; font-size: 13px; border-left: 4px solid var(--accent-cyan); transition: all 0.4s ease; transform-origin: bottom center; }
        .toast.toast-entering { opacity: 0; transform: translateY(20px); }
        .toast.toast-exiting { opacity: 0; transform: scale(0.9); }
        .toast.success { border-color: var(--accent-green); }
        .toast.fail { border-color: var(--accent-red); }
        .toast.achievement { border-color: var(--accent-yellow); color: var(--accent-yellow); font-weight: bold; }
        .panel { margin: auto; width: 90%; background: var(--glass-bg); backdrop-filter: blur(20px); border: 1px solid var(--glass-border); border-radius: 24px; box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3); padding: 24px; text-align: center; transition: border-color 0.3s; }
        .upgrade-item, .log-item, .achievement-item { padding: 12px; border: 1px solid var(--glass-border); border-radius: 8px; margin-bottom: 8px; text-align: left; }
        .upgrade-item.unlocked, .achievement-item.unlocked { border-color: var(--accent-green); background-color: rgba(74, 222, 128, 0.1); }
        .upgrade-item h4, .achievement-item h4 { color: var(--accent-yellow); }

        #radar { position: relative; width: 320px; height: 320px; display: flex; justify-content: center; align-items: center; }
        .scanner-disk { width: 280px; height: 280px; background-color: rgba(10, 25, 47, 0.5); border: 2px solid rgba(7, 245, 245, 0.3); border-radius: 50%; box-shadow: 0 0 40px var(--glow-cyan) inset, 0 0 10px var(--glow-cyan); animation: pulse-disk 4s infinite ease-in-out; position: relative; overflow: hidden; }
        .scanner-disk::before { content: ''; position: absolute; inset: 0; border-radius: 50%; pointer-events: none; background-image: radial-gradient(rgba(7, 245, 245, 0.1) 1px, transparent 1px), radial-gradient(rgba(7, 245, 245, 0.1) 1px, transparent 1px); background-size: 20px 20px; background-position: 0 0, 10px 10px; }
        .scanner-line { position: absolute; left: 5%; width: 90%; height: var(--scan-line-height, 3px); background: linear-gradient(90deg, transparent, var(--accent-cyan), transparent); box-shadow: 0 0 15px 3px var(--glow-cyan); border-radius: 3px; animation: scan-line 4s ease-in-out infinite; top: 10%; transition: height 0.3s ease; }
        .target-dot { position: absolute; border-radius: 50%; transform: translate(var(--tx, 0px), var(--ty, 0px)) scale(var(--s, 1)); transition: transform 0.1s linear, box-shadow 0.3s ease, opacity 0.3s ease; cursor: pointer; background-color: var(--accent-green); box-shadow: 0 0 10px var(--glow-green); opacity: 1; min-width: 12px; min-height: 12px; }
        .dot-decoy { background-color: var(--accent-red); box-shadow: 0 0 10px var(--glow-red); }
        .dot-epic { background-color: var(--accent-purple); box-shadow: 0 0 10px var(--glow-purple); }
        .dot-target { background-color: var(--accent-cyan); box-shadow: 0 0 10px var(--glow-cyan); }
        .blink { animation: blink 0.3s; }
        @keyframes blink { 50% { opacity: 0.5; } }
        @keyframes pulse-disk { 50% { box-shadow: 0 0 50px var(--glow-cyan) inset, 0 0 20px var(--glow-cyan); } }
        @keyframes scan-line { 0%, 100% { top: 10%; } 50% { top: 90%; } }
        
        #varna-container { width: 100%; height: 60px; background-color: rgba(0,0,0,0.3); border: 1px solid var(--glass-border); border-radius: 10px; position: relative; overflow: hidden; }
        #varna-bar { position: absolute; top: 0; left: 0; width: 2%; height: 100%; background-color: var(--accent-cyan); animation: varna-move 3s ease-in-out infinite; }
        #varna-zone { position: absolute; top: 0; height: 100%; width: 15%; background-color: rgba(74, 222, 128, 0.5); border-left: 2px solid var(--accent-green); border-right: 2px solid var(--accent-green); }
        @keyframes varna-move { 0% { left: 0%; } 50% { left: 98%; } 100% { left: 0%; } }
        .tutorial { position: absolute; bottom: 80px; text-align: center; font-size: 12px; color: var(--text-secondary); }
    </style>
</head>
<body>
    <canvas id="webgl-canvas"></canvas>
    <div id="root" role="application">
        <div id="stage">
            <div id="scene-menu" class="scene items-center justify-center">
                <div class="panel">
                    <h1 class="font-orbitron text-4xl font-black text-cyan-300 mb-2" style="text-shadow: 0 0 15px var(--glow-cyan);">NAJDI SMAŽÁK</h1>
                    <p class="text-slate-400 mb-6">v17.4 - Vylepšená Detekce</p>
                    <div class="flex flex-col gap-3">
                        <button data-action="play" class="btn w-full">NOVÁ HRA</button>
                        <button data-action="continue" class="btn w-full hidden" style="background: linear-gradient(45deg, #4ade80, #22c55e); box-shadow: 0 0 20px rgba(74, 222, 128, 0.45);">POKRAČOVAT</button>
                        <button data-action="show-upgrades" class="btn w-full" style="background: linear-gradient(45deg, #fde047, #f59e0b); box-shadow: 0 0 20px rgba(250, 204, 21, 0.45);">SKLAD</button>
                        <button data-action="show-logs" class="btn w-full" style="background: linear-gradient(45deg, #c355f7, #9333ea); box-shadow: 0 0 20px rgba(195, 85, 247, 0.45);">DENÍK & ÚSPĚCHY</button>
                    </div>
                </div>
            </div>

            <div id="scene-dispatcher" class="scene hidden">
                <header id="hud" aria-label="Herní statistiky">
                    <div class="text-left"><div class="hud-pill">DEN <b id="stat-day">1</b></div></div>
                    <div id="hud-title" class="font-orbitron font-bold text-lg text-cyan-300 text-center">DISPEČINK</div>
                    <div class="text-right"><div class="hud-pill">REPUTACE <b id="stat-rep">0</b></div></div>
                </header>
                <main class="flex-1 flex flex-col justify-center items-center p-4">
                    <div id="event-panel" class="panel w-full mb-4 hidden"></div>
                    <div id="job-panel" class="panel w-full">
                        <div id="job-placeholder">
                            <h2 class="font-orbitron text-xl font-bold text-cyan-300 mb-2">ŽÁDNÝ SIGNÁL</h2>
                            <p class="text-slate-400">Potřebuješ nasbírat <b id="intel-needed" class="text-yellow-300"></b> intelu.</p>
                            <p class="text-xs text-slate-500 mt-2">Aktuálně: <b id="intel-current" class="text-yellow-400"></b> | Heat: <b id="heat-current" class="text-red-400"></b></p>
                        </div>
                        <div id="job-details" class="hidden">
                            <h2 class="font-orbitron text-xl font-bold text-cyan-300 mb-2">PŘÍCHOZÍ ÚKOL</h2>
                            <div id="job-contact-avatar" class="mx-auto my-3 w-16 h-16 bg-slate-800/50 rounded-full flex items-center justify-center font-orbitron font-black text-2xl border-2 p-2"></div>
                            <h3 id="job-contact-name" class="text-lg font-bold text-yellow-300"></h3>
                            <p id="job-description" class="text-slate-300 my-4"></p>
                        </div>
                    </div>
                </main>
                <footer id="actions" class="p-4">
                    <button data-action="scan" class="btn w-full">SKENOVAT OBLAST</button>
                    <button data-action="accept-job" class="btn w-full hidden">PŘIJMOUT ÚKOL</button>
                </footer>
            </div>

            <div id="scene-scan" class="scene hidden items-center justify-center">
                <div class="panel absolute top-4 w-auto"><h2 class="font-orbitron text-xl font-bold text-cyan-300">NAJDI ZDROJOVÝ SIGNÁL</h2></div>
                <div id="radar">
                    <div class="scanner-disk">
                        <div class="target-dots-container"></div>
                    </div>
                    <div class="scanner-line"></div>
                </div>
                <p class="tutorial">Klikni na cyanové/fialové tečky pro intel. Vyhněte se červeným návnadám!</p>
                 <button data-action="scan-back" class="btn absolute bottom-4 w-1/2 bg-gray-500/80" style="background: #4b5563; box-shadow: none;">ZPĚT</button>
            </div>

            <div id="scene-minigame-varna" class="scene hidden items-center justify-center">
                <div class="panel">
                    <h2 class="font-orbitron text-xl font-bold text-cyan-300 mb-4">KALIBRACE TEPLOTY</h2>
                    <p class="text-slate-400 mb-4">Zastav sondu v zelené zóně pro maximální čistotu!</p>
                    <div id="varna-container">
                        <div id="varna-zone"></div>
                        <div id="varna-bar"></div>
                    </div>
                    <button data-action="minigame-varna-stop" class="btn w-full mt-6">ZASTAVIT</button>
                </div>
            </div>
            <div id="scene-minigame-deal" class="scene hidden items-center justify-center">
                <div class="panel">
                    <h2 class="font-orbitron text-xl font-bold text-yellow-300 mb-4">PŘEDÁVKA PROBÍHÁ</h2>
                    <p class="text-slate-400">Zůstaň ve stínu a čekej na signál...</p>
                    <div class="w-full bg-slate-700 rounded-full h-2.5 mt-4"><div class="bg-yellow-400 h-2.5 rounded-full animate-pulse"></div></div>
                </div>
            </div>
            <div id="scene-minigame-chill" class="scene hidden items-center justify-center">
                <div class="panel">
                    <h2 class="font-orbitron text-xl font-bold text-green-400 mb-4">RELAXACE</h2>
                    <p class="text-slate-400">Udržuj nízký profil a klidnou hlavu...</p>
                    <div class="w-full bg-slate-700 rounded-full h-2.5 mt-4"><div class="bg-green-400 h-2.5 rounded-full animate-pulse"></div></div>
                </div>
            </div>
             <div id="scene-game-over" class="scene hidden items-center justify-center">
                <div class="panel text-center">
                    <h1 class="font-orbitron text-4xl font-black text-red-500 mb-2" style="text-shadow: 0 0 15px var(--glow-red);">SIGNÁL ZTRACEN</h1>
                    <p class="text-slate-400 mb-6">Příliš velký heat. Musels zmizet ze sítě.</p>
                    <button data-action="restart" class="btn w-full">ZAČÍT ZNOVU</button>
                </div>
            </div>
            
            <div id="scene-upgrades" class="scene hidden items-center justify-center"></div>
            <div id="scene-logs" class="scene hidden items-center justify-center"></div>
            <div id="toast-container" aria-live="assertive" aria-atomic="true"></div>
        </div>
    </div>

    <template id="template-upgrades">
        <div class="panel">
            <h2 class="font-orbitron text-2xl font-bold text-cyan-300 mb-2">VYLEPŠENÍ SKLADU</h2>
            <p class="mb-4">Reputace: <b id="upgrades-rep-label">0</b></p>
            <div id="upgrades-list" class="max-h-64 overflow-y-auto"></div>
            <button data-action="back-to-menu" class="btn w-full bg-gray-500/80 mt-4" style="background: #4b5563; box-shadow: none;">ZPĚT DO MENU</button>
        </div>
    </template>
    <template id="template-logs">
        <div class="panel w-full">
            <h2 class="font-orbitron text-2xl font-bold text-cyan-300 mb-4">DENÍK & ÚSPĚCHY</h2>
            <h3 class="font-orbitron text-lg font-bold text-yellow-300 mb-2 text-left">ÚSPĚCHY</h3>
            <div id="achievements-list" class="max-h-32 overflow-y-auto mb-4"></div>
            <h3 class="font-orbitron text-lg font-bold text-yellow-300 mb-2 text-left">ZÁPISKY ZE DNA</h3>
            <div id="logs-list" class="max-h-40 overflow-y-auto text-left text-sm text-slate-400"></div>
            <button data-action="back-to-menu" class="btn w-full bg-gray-500/80 mt-4" style="background: #4b5563; box-shadow: none;">ZPĚT DO MENU</button>
        </div>
    </template>

    <script type="module">
        import * as THREE from 'three';
        import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
        import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
        import { GlitchPass } from 'three/addons/postprocessing/GlitchPass.js';

        document.addEventListener('DOMContentLoaded', () => {
            const STATE_VERSION = 17.4;
            const MAX_HEAT = 10;
            const DATA = {
                subjects: [ { id: 'slehac', color: 'var(--accent-red)', name: 'Šlehař Delta-Piko', logPhrases: ['Vařím dávku, drž se', 'Šlehám vrstvičku I', 'Dealer hlásí, že zboží jede', 'Piko čistota 78 %, dobrý', 'Připravuju stříkačku', 'Váha ukazuje přesně, dneska to bude jízda.', 'Filtruju přes cigaretu, klasika.'] }, { id: 'hulic', color: 'var(--accent-green)', name: 'Hulič Zubatá Žárovka', logPhrases: ['Přepaluju sklo', 'Už to bublá, kámo', 'Mám totální červený oči', 'Kde je zapalovač?', 'Tohle je silnej model', 'Tenhle model lepí prsty, to je dobře.', 'Sháním papírky, došly mi.'] }, { id: 'domingo', color: 'var(--accent-yellow)', name: 'Domingo ze Smíchova', logPhrases: ['Mám čerstvej matroš, chceš?', 'Dneska akce, dva za cenu jednoho.', 'Bacha, za rohem stojej fízlové.', 'Platba jen v hotovosti, kámo.', 'Tohle je čistý, přísahám.'] }, { id: 'pedro', color: 'var(--accent-cyan)', name: 'Pedro Perníček', logPhrases: ['Jsem na cestě, čekej.', 'Už jsem za rohem, připrav prachy.', 'Máš přesně? Nemám na vrácení.', 'Dneska mám zpoždění, kolony.', 'Nová várka, silnější než minule.'] }, { id: 'sypac', color: 'var(--accent-purple)', name: 'Sypač Kartelovej Kocour', logPhrases: ['Sypu čáru na CDčko.', 'Pytlíky zamotaný, trvá to.', 'Někdo klepe na dveře, stopka.', 'Šňůra rovná jak pravítko.', 'Prášek se sype sám.'] }, ],
                jobTemplates: [
                    { type: 'cook', character: 'slehac', description: 'Šlehař potřebuje dohled nad novou várkou. Ujisti se, že to nepokazí.', minigame: 'varna', intelRequired: 10, repReward: 2 },
                    { type: 'deal', character: 'domingo', description: 'Domingo má kupce na Smíchově. Musí to proběhnout čistě a rychle.', minigame: 'deal', intelRequired: 15, repReward: 3 },
                    { type: 'chill', character: 'hulic', description: 'Hulič testuje nový model a potřebuje udržet klidnou hlavu. Pomoz mu s tím.', minigame: 'chill', intelRequired: 8, repReward: 1 },
                ],
                upgrades: {
                    scanWidth: { name: 'Širší Scanner', description: 'Zvětšuje detekční okno skenovací linky.', cost: 3, unlocked: false },
                    heatSink: { name: 'Tichý režim', description: 'Snižuje nárůst "heatu" při zasažení návnady.', cost: 5, unlocked: false },
                    intelBoost: { name: 'Zesilovač Signálu', description: 'Zvyšuje šanci na nalezení epického signálu (více intelu).', cost: 8, unlocked: false },
                    dotVisibility: { name: 'Zlepšená Viditelnost', description: 'Tečky jsou viditelnější a větší.', cost: 4, unlocked: false },
                },
                achievements: { dealerHunter: { name: 'Certified Dealer Hunter', description: 'Dokonči 10 úspěšných misí.', unlocked: false, condition: (state) => state.jobsCompleted >= 10 }, masterCook: { name: 'Master Cook', description: 'Dokonči vaření s čistotou 100%.', unlocked: false, condition: (state, result) => result?.minigame === 'varna' && result?.purity === 100 }, },
                randomEvents: [
                    { id: 'police_raid', title: 'Policejní Razie!', description: 'V oblasti je zvýšená aktivita. Dnes bude všechno víc horký.', effect: (state) => { state.heat += 3; return `Heat se okamžitě zvýšil o 3!`; } },
                    { id: 'double_rep', title: 'Zlatá Horečka', description: 'Poptávka je obrovská. Dneska jsou odměny dvojnásobné!', effect: (state) => { state.eventFlags.doubleRep = true; return `Všechny odměny reputace jsou dnes dvojnásobné.`; } },
                    { id: 'signal_boost', title: 'Solární Bouře', description: 'Atmosférické poruchy zesilují signály. Snadněji získáš intel.', effect: (state) => { state.eventFlags.signalBoost = true; return `Zisk intelu ze skenování je o 1 vyšší.`; } },
                ]
            };
            DATA.subjects.forEach(s => { s.avatar = `<svg viewBox="0 0 100 100" style="fill:${s.color}; stroke:${s.color};"><text x="50" y="55" font-size="60" text-anchor="middle" dominant-baseline="central" font-family="Orbitron">${s.name.charAt(0)}</text></svg>`; });

            class AudioManager { constructor() { this.isInitialized = false; this.synth = new Tone.Synth({ oscillator: { type: 'sine' }, envelope: { attack: 0.005, decay: 0.1, sustain: 0.3, release: 1 } }).toDestination(); } async init() { if (this.isInitialized) return; try { await Tone.start(); this.isInitialized = true; } catch(e) { console.error("Could not initialize audio context.", e); } } playBeep() { if(!this.isInitialized) this.init(); this.synth.triggerAttackRelease("C5", "8n"); } playSuccess() { if(!this.isInitialized) this.init(); this.synth.triggerAttackRelease("G5", "8n", Tone.now()); this.synth.triggerAttackRelease("C6", "8n", Tone.now() + 0.1); } playFailure() { if(!this.isInitialized) this.init(); this.synth.triggerAttackRelease("C4", "4n"); } }
            class InteractiveBackground { constructor(container) { this.container = container; this.scene = new THREE.Scene(); this.camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000); this.renderer = new THREE.WebGLRenderer({ canvas: this.container, alpha: true }); this.composer = null; this.glitchPass = null; this.init(); } init() { this.renderer.setSize(window.innerWidth, window.innerHeight); this.renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2)); this.camera.position.z = 5; this.scene.fog = new THREE.Fog(0x0a192f, 5, 15); this.composer = new EffectComposer(this.renderer); this.composer.addPass(new RenderPass(this.scene, this.camera)); this.glitchPass = new GlitchPass(); this.glitchPass.enabled = false; this.composer.addPass(this.glitchPass); const particleCount = 1000; const positions = new Float32Array(particleCount * 3); for (let i = 0; i < particleCount * 3; i++) { positions[i] = (Math.random() - 0.5) * 20; } const particlesGeometry = new THREE.BufferGeometry(); particlesGeometry.setAttribute('position', new THREE.BufferAttribute(positions, 3)); const particlesMaterial = new THREE.PointsMaterial({ size: 0.02, color: 0x475569, transparent: true, opacity: 0.5 }); const dust = new THREE.Points(particlesGeometry, particlesMaterial); this.scene.add(dust); window.addEventListener('resize', this.onWindowResize.bind(this)); this.animate(); } onWindowResize() { this.camera.aspect = window.innerWidth / window.innerHeight; this.camera.updateProjectionMatrix(); this.renderer.setSize(window.innerWidth, window.innerHeight); this.composer.setSize(window.innerWidth, window.innerHeight); } triggerGlitch(duration = 500) { if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) return; this.glitchPass.enabled = true; setTimeout(() => { this.glitchPass.enabled = false; }, duration); } animate() { requestAnimationFrame(this.animate.bind(this)); this.composer.render(); } }
            class RadarScanner {
                constructor(radarElementId, config, callbacks) { this.radar = document.getElementById(radarElementId); if (!this.radar) return; this.callbacks = callbacks; this.config = config; this.scanLine = this.radar.querySelector('.scanner-line'); this.dotsContainer = this.radar.querySelector('.target-dots-container'); this.dots = []; this.isActive = false; this.animationFrameId = null; }
                start() { this.isActive = true; this.dotsContainer.innerHTML = ''; this.dots = []; this.generateDots(); this.animationFrameId = requestAnimationFrame(() => this.scanLoop()); }
                stop() { this.isActive = false; if (this.animationFrameId) cancelAnimationFrame(this.animationFrameId); this.animationFrameId = null; }
                generateDots() { const scannerRadius = this.dotsContainer.offsetWidth / 2; let targetCount = 0; for (let i = 0; i < this.config.dotCount; i++) { const dotEl = document.createElement('div'); const size = Math.floor(Math.random() * 5) + 12; let dotType = 'decoy'; if (targetCount < this.config.maxTargets && Math.random() < this.config.targetChance) { dotType = Math.random() < this.config.epicChance ? 'epic' : 'target'; targetCount++; } dotEl.className = `target-dot dot-${dotType}`; dotEl.style.width = `${size}px`; dotEl.style.height = `${size}px`; const angle = Math.random() * 2 * Math.PI; const radius = Math.sqrt(Math.random()) * (scannerRadius - size); const x = scannerRadius + radius * Math.cos(angle) - size / 2; const y = scannerRadius + radius * Math.sin(angle) - size / 2; dotEl.style.left = `${x}px`; dotEl.style.top = `${y}px`; const dot = { element: dotEl, type: dotType, wasInScanWindow: false }; dotEl.addEventListener('click', (e) => { e.stopPropagation(); if (!this.isActive) return; this.callbacks.hit(dot); }); this.dotsContainer.appendChild(dotEl); this.dots.push(dot); } }
                scanLoop() { if (!this.isActive) return; const lineRect = this.scanLine.getBoundingClientRect(); this.dots.forEach(dot => { const dotRect = dot.element.getBoundingClientRect(); const isCurrentlyInScanWindow = (lineRect.bottom > dotRect.top && lineRect.top < dotRect.bottom); if (isCurrentlyInScanWindow && !dot.wasInScanWindow) { dot.element.classList.add('blink'); setTimeout(() => dot.element.classList.remove('blink'), 300); } dot.wasInScanWindow = isCurrentlyInScanWindow; }); this.animationFrameId = requestAnimationFrame(() => this.scanLoop()); }
            }

            class SmazakGame {
                constructor() { this.state = null; this.radar = null; this.saveStateDebounced = this.debounce(() => this.saveState(), 300); this.elements = { stage: document.getElementById('stage'), scenes: { menu: document.getElementById('scene-menu'), dispatcher: document.getElementById('scene-dispatcher'), scan: document.getElementById('scene-scan'), upgrades: document.getElementById('scene-upgrades'), logs: document.getElementById('scene-logs'), 'minigame-varna': document.getElementById('scene-minigame-varna'), 'minigame-deal': document.getElementById('scene-minigame-deal'), 'minigame-chill': document.getElementById('scene-minigame-chill'), 'game-over': document.getElementById('scene-game-over') }, buttons: { continue: document.querySelector('[data-action="continue"]') }, hud: { day: document.getElementById('stat-day'), rep: document.getElementById('stat-rep') }, job: { panel: document.getElementById('job-panel'), placeholder: document.getElementById('job-placeholder'), details: document.getElementById('job-details'), avatar: document.getElementById('job-contact-avatar'), name: document.getElementById('job-contact-name'), description: document.getElementById('job-description'), intelNeeded: document.getElementById('intel-needed'), intelCurrent: document.getElementById('intel-current'), heatCurrent: document.getElementById('heat-current') }, eventPanel: document.getElementById('event-panel'), templates: { upgrades: document.getElementById('template-upgrades'), logs: document.getElementById('template-logs') }, toastContainer: document.getElementById('toast-container'), }; this.background = new InteractiveBackground(document.getElementById('webgl-canvas')); this.audio = new AudioManager(); this.init(); }

                init() { this.loadState(); this.scaleStage(); this.setupEventListeners(); this.setGameState('menu'); }
                debounce = (func, delay) => { let timeout; return (...args) => { clearTimeout(timeout); timeout = setTimeout(() => func.apply(this, args), delay); }; };
                getRandomElement = (arr) => arr[Math.floor(Math.random() * arr.length)];
                scaleStage = () => { const scale = Math.min(window.innerWidth / 360, window.innerHeight / 640); this.elements.stage.style.transform = `scale(${scale})`; };
                vibrate = (pattern) => { if (navigator.vibrate) navigator.vibrate(pattern); };

                saveState() { localStorage.setItem(`smazakGameState_v${STATE_VERSION}`, JSON.stringify(this.state)); }
                loadState() { const defaultState = { version: STATE_VERSION, gameState: 'menu', day: 1, reputation: 0, intel: 0, heat: 0, nextJobIntel: 10, currentJob: null, jobsCompleted: 0, upgrades: JSON.parse(JSON.stringify(DATA.upgrades)), achievements: JSON.parse(JSON.stringify(DATA.achievements)), logEntries: [], eventFlags: {}, }; let savedState = null; const savedStateJSON = localStorage.getItem(`smazakGameState_v${STATE_VERSION}`); if (savedStateJSON) { try { savedState = JSON.parse(savedStateJSON); if (savedState.version !== STATE_VERSION) { savedState = null; } } catch (e) { savedState = null; } } this.state = { ...defaultState, ...savedState }; }

                setGameState(newState) {
                    if(this.radar) this.radar.stop();
                    this.state.gameState = newState;
                    Object.values(this.elements.scenes).forEach(s => s.classList.add('hidden'));
                    const scene = this.elements.scenes[newState];
                    if (scene) { setTimeout(() => scene.classList.remove('hidden'), 50); }
                    this.audio.playBeep();
                    
                    if (newState === 'menu') {
                        const hasSave = !!localStorage.getItem(`smazakGameState_v${STATE_VERSION}`);
                        this.elements.buttons.continue.classList.toggle('hidden', !hasSave);
                    } else if (newState === 'dispatcher') { this.updateDispatcherUI();
                    } else if (newState === 'upgrades') { this.renderUpgrades();
                    } else if (newState === 'logs') { this.renderLogsAndAchievements(); }
                }
                
                setupEventListeners() {
                    window.addEventListener('resize', this.scaleStage);
                    this.elements.stage.addEventListener('click', (e) => {
                        const target = e.target.closest('[data-action]');
                        if (!target) return;
                        const action = target.dataset.action;
                        const actions = {
                            'play': () => this.startGame(true),
                            'continue': () => this.startGame(false),
                            'restart': () => this.startGame(true),
                            'show-upgrades': () => this.setGameState('upgrades'),
                            'show-logs': () => this.setGameState('logs'),
                            'back-to-menu': () => this.setGameState('menu'),
                            'scan': () => this.startScan(),
                            'scan-back': () => this.setGameState('dispatcher'),
                            'accept-job': () => this.startCurrentJob(),
                            'minigame-varna-stop': () => this.endMinigameVarna(),
                            'buy-upgrade': () => this.buyUpgrade(target.closest('[data-upgrade-id]').dataset.upgradeId)
                        };
                        if (actions[action]) actions[action]();
                    });
                }

                startGame(isNewGame) {
                    if (isNewGame) { localStorage.removeItem(`smazakGameState_v${STATE_VERSION}`); this.loadState(); }
                    this.startNewDay(); this.setGameState('dispatcher');
                }

                startNewDay() {
                    this.state.eventFlags = {}; this.elements.eventPanel.classList.add('hidden');
                    if (Math.random() < 0.25) {
                        const event = this.getRandomElement(DATA.randomEvents);
                        const effectMessage = event.effect(this.state);
                        this.elements.eventPanel.innerHTML = `<h3 class="font-orbitron font-bold text-yellow-300">${event.title}</h3><p class="text-sm text-slate-300">${event.description}</p><p class="text-xs text-cyan-300 mt-1">${effectMessage}</p>`;
                        this.elements.eventPanel.classList.remove('hidden'); this.toast(event.title, 'info'); this.checkHeat();
                    } this.saveState();
                }

                updateDispatcherUI() {
                    const jobReady = this.state.intel >= this.state.nextJobIntel;
                    if (jobReady && !this.state.currentJob) { this.generateNewJob(); }
                    const hasJob = !!this.state.currentJob;
                    this.elements.job.placeholder.classList.toggle('hidden', hasJob);
                    this.elements.job.details.classList.toggle('hidden', !hasJob);
                    document.querySelector('[data-action="scan"]').classList.toggle('hidden', hasJob);
                    document.querySelector('[data-action="accept-job"]').classList.toggle('hidden', !hasJob);
                    if (hasJob) { const character = DATA.subjects.find(s => s.id === this.state.currentJob.character); this.elements.job.avatar.innerHTML = character.avatar; this.elements.job.avatar.style.borderColor = character.color; this.elements.job.panel.style.borderColor = character.color; this.elements.job.name.textContent = character.name; this.elements.job.description.textContent = this.state.currentJob.description;
                    } else { this.elements.job.intelNeeded.textContent = this.state.nextJobIntel; this.elements.job.intelCurrent.textContent = this.state.intel; this.elements.job.heatCurrent.textContent = this.state.heat; }
                    this.updateHUD();
                }

                generateNewJob() { this.state.currentJob = this.getRandomElement(DATA.jobTemplates); }

                startScan() {
                    this.elements.stage.classList.add('is-shaking'); setTimeout(() => this.elements.stage.classList.remove('is-shaking'), 400); this.background.triggerGlitch(400); this.setGameState('scan');
                    const radarEl = document.getElementById('radar');
                    radarEl.style.setProperty('--scan-line-height', this.state.upgrades.scanWidth.unlocked ? '15px' : '3px');
                    const radarConfig = { dotCount: 12, maxTargets: 4, targetChance: 0.5 - (this.state.heat * 0.01), epicChance: this.state.upgrades.intelBoost.unlocked ? 0.3 : 0.1 };
                    this.radar = new RadarScanner('radar', radarConfig, { hit: (dot) => this.onRadarHit(dot) }); this.radar.start();
                }

                onRadarHit(dot) {
                    this.radar.stop(); this.vibrate(50);
                    if (dot.type === 'decoy') {
                        const heatGain = this.state.upgrades.heatSink.unlocked ? 1 : 2; this.state.heat += heatGain;
                        this.toast(`Návnada! Heat +${heatGain}`, 'fail'); this.audio.playFailure(); this.checkHeat();
                    } else {
                        let intelGain = dot.type === 'epic' ? 5 : 2; if(this.state.eventFlags.signalBoost) intelGain++;
                        this.state.intel += intelGain; this.toast(`Signál zaměřen! Intel +${intelGain}`, 'success'); this.audio.playSuccess();
                    } this.saveStateDebounced(); setTimeout(() => this.setGameState('dispatcher'), 500);
                }

                checkHeat() { if (this.state.heat >= MAX_HEAT) { this.setGameState('game-over'); } }

                startCurrentJob() {
                    const minigame = this.state.currentJob.minigame; this.setGameState(`minigame-${minigame}`);
                    if (minigame === 'varna') { const zone = document.getElementById('varna-zone'); zone.style.left = `${Math.floor(Math.random() * 51) + 20}%`;
                    } else if (minigame === 'deal' || minigame === 'chill') { setTimeout(() => { if (this.state.gameState === `minigame-${minigame}`) { this.endMinigame(true, 'Akce proběhla hladce.', 100); } }, 3000); }
                }

                endMinigameVarna() {
                    const bar = document.getElementById('varna-bar'); const zone = document.getElementById('varna-zone');
                    const barRect = bar.getBoundingClientRect(); const zoneRect = zone.getBoundingClientRect();
                    const isInside = barRect.left >= zoneRect.left && barRect.right <= zoneRect.right;
                    const success = isInside;
                    const purity = success ? 100 : 0;
                    const message = success ? 'Perfektní kalibrace!' : 'Kalibrace selhala.';
                    this.endMinigame(success, message, purity);
                }

                endMinigame(success, message, purity = 100) {
                    this.toast(message, success ? 'success' : 'fail');
                    const minigame = this.state.currentJob.minigame;
                    if (success) {
                        let repGain = this.state.currentJob.repReward;
                        if (this.state.eventFlags.doubleRep) repGain *= 2;
                        this.state.reputation += repGain;
                        this.state.jobsCompleted++;
                        this.addLogEntry();
                        this.checkAchievements({ minigame, purity });
                    } else {
                        this.state.heat += 2;
                        this.checkHeat();
                    }
                    this.state.intel = 0;
                    this.state.currentJob = null;
                    this.state.nextJobIntel = Math.floor(Math.random() * 10) + 5;
                    this.state.day++;
                    this.startNewDay();
                    this.setGameState('dispatcher');
                    this.saveState();
                }

                checkAchievements(result = null) {
                    for (let key in this.state.achievements) {
                        const ach = this.state.achievements[key];
                        if (!ach.unlocked && ach.condition(this.state, result)) {
                            ach.unlocked = true;
                            this.toast(`Úspěch: ${ach.name}`, 'achievement');
                        }
                    }
                }

                addLogEntry() {
                    const character = DATA.subjects.find(s => s.id === this.state.currentJob.character);
                    const phrase = this.getRandomElement(character.logPhrases);
                    this.state.logEntries.push(`Den ${this.state.day}: ${phrase}`);
                }

                updateHUD() {
                    this.elements.hud.day.textContent = this.state.day;
                    this.elements.hud.rep.textContent = this.state.reputation;
                }

                toast(message, type, duration = 3000) {
                    const toast = document.createElement('div');
                    toast.className = `toast toast-entering ${type}`;
                    toast.textContent = message;
                    this.elements.toastContainer.appendChild(toast);
                    setTimeout(() => toast.classList.remove('toast-entering'), 50);
                    setTimeout(() => {
                        toast.classList.add('toast-exiting');
                        setTimeout(() => toast.remove(), 400);
                    }, duration);
                }

                renderUpgrades() {
                    const container = this.elements.scenes.upgrades;
                    container.innerHTML = this.elements.templates.upgrades.innerHTML;
                    const list = container.querySelector('#upgrades-list');
                    for (let id in this.state.upgrades) {
                        const u = this.state.upgrades[id];
                        const el = document.createElement('div');
                        el.className = `upgrade-item ${u.unlocked ? 'unlocked' : ''}`;
                        el.dataset.upgradeId = id;
                        el.innerHTML = `<h4>${u.name}</h4><p>${u.description}</p><p>Cena: ${u.cost} rep</p>${u.unlocked ? '<p>Zakoupeno</p>' : '<button data-action="buy-upgrade">Koupit</button>'}`;
                        list.appendChild(el);
                    }
                    container.querySelector('#upgrades-rep-label').textContent = this.state.reputation;
                }

                buyUpgrade(id) {
                    const u = this.state.upgrades[id];
                    if (u.unlocked || this.state.reputation < u.cost) return;
                    this.state.reputation -= u.cost;
                    u.unlocked = true;
                    this.toast(`${u.name} zakoupeno!`, 'success');
                    this.renderUpgrades();
                    this.saveState();
                }

                renderLogsAndAchievements() {
                    const container = this.elements.scenes.logs;
                    container.innerHTML = this.elements.templates.logs.innerHTML;
                    const achList = container.querySelector('#achievements-list');
                    for (let id in this.state.achievements) {
                        const a = this.state.achievements[id];
                        const el = document.createElement('div');
                        el.className = `achievement-item ${a.unlocked ? 'unlocked' : ''}`;
                        el.innerHTML = `<h4>${a.name}</h4><p>${a.description}</p>`;
                        achList.appendChild(el);
                    }
                    const logList = container.querySelector('#logs-list');
                    this.state.logEntries.forEach(log => {
                        const el = document.createElement('div');
                        el.className = 'log-item';
                        el.textContent = log;
                        logList.appendChild(el);
                    });
                }
            }

            new SmazakGame();
        });
    </script>
</body>
</html>