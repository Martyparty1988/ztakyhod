<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Piko Přepadení</title>

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Piko Přepadení">
    <meta name="theme-color" content="#0a192f">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="assets/icons/icon-192x192.png">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Share+Tech+Mono&display=swap" rel="stylesheet">

    <!-- Knihovna Tone.js pro generování zvuků -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.min.js"></script>

    <style>
        /* --- Globální nastavení a proměnné --- */
        :root {
            --primary-dark: #0a192f;
            --neon-blue: #00f6ff;
            --neon-purple: #a855f7;
            --light-text: #ccd6f6;
            --dark-text: #8892b0;
            --glass-bg: rgba(23, 42, 69, 0.3);
            --glass-border: rgba(0, 246, 255, 0.2);
            
            --font-header: 'Orbitron', sans-serif;
            --font-body: 'Share Tech Mono', monospace;

            /* Safe areas for iPhone notch */
            --safe-area-top: env(safe-area-inset-top, 20px);
            --safe-area-bottom: env(safe-area-inset-bottom, 20px);
            --safe-area-left: env(safe-area-inset-left, 20px);
            --safe-area-right: env(safe-area-inset-right, 20px);
        }

        /* --- Základní styly --- */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: var(--primary-dark);
            color: var(--light-text);
            font-family: var(--font-body);
            -webkit-tap-highlight-color: transparent; /* Disable tap highlight on iOS */
        }

        #game-container {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #game-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(180deg, #0a192f 0%, #172a46 70%, #303C55 100%);
        }

        /* --- HUD (Heads-Up Display) --- */
        #hud {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            padding: 15px;
            padding-top: calc(15px + var(--safe-area-top));
            padding-left: calc(15px + var(--safe-area-left));
            padding-right: calc(15px + var(--safe-area-right));
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 10;
            pointer-events: none;
        }

        .hud-item {
            display: flex;
            align-items: center;
            font-size: 1.5rem;
            font-family: var(--font-header);
            text-shadow: 0 0 5px var(--neon-blue);
            background: var(--glass-bg);
            padding: 8px 15px;
            border-radius: 20px;
            border: 1px solid var(--glass-border);
            backdrop-filter: blur(5px);
        }
        
        .hud-item-right {
            pointer-events: all;
        }

        .hud-item span {
            margin-left: 10px;
        }

        .hud-item svg {
            width: 24px;
            height: 24px;
            fill: var(--neon-blue);
            filter: drop-shadow(0 0 3px var(--neon-blue));
        }

        /* --- Glassmorphism Panely (Menu, Game Over) --- */
        .glass-panel {
            position: absolute;
            width: calc(100% - 40px);
            max-width: 350px;
            padding: 30px;
            padding-bottom: calc(30px + var(--safe-area-bottom));
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            z-index: 20;
            display: none; /* Skryto defaultně */
            flex-direction: column;
            align-items: center;
            text-align: center;
            animation: fadeIn 0.5s ease-out;
        }

        .glass-panel.active {
            display: flex;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        .game-title {
            font-family: var(--font-header);
            font-size: 2.5rem;
            color: var(--neon-blue);
            text-shadow: 0 0 10px var(--neon-blue), 0 0 20px var(--neon-blue);
            margin-bottom: 5px;
        }

        .game-subtitle {
            font-size: 1rem;
            color: var(--dark-text);
            margin-bottom: 30px;
        }

        .menu-title {
            font-family: var(--font-header);
            font-size: 2rem;
            color: var(--neon-purple);
            text-shadow: 0 0 8px var(--neon-purple);
            margin-bottom: 15px;
        }

        .quote-text, .score-summary p {
            font-size: 1.1rem;
            color: var(--light-text);
            margin-bottom: 15px;
        }

        .score-summary {
            margin: 20px 0;
        }

        /* --- Tlačítka --- */
        .ui-button {
            min-width: 44px;
            min-height: 44px;
            padding: 10px 20px;
            font-family: var(--font-header);
            font-size: 1rem;
            color: var(--light-text);
            background: transparent;
            border: 2px solid var(--neon-purple);
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            text-shadow: 0 0 5px var(--neon-purple);
            box-shadow: 0 0 10px 0 var(--neon-purple) inset, 0 0 10px 0 var(--neon-purple);
        }

        .ui-button:hover, .ui-button:focus {
            background: rgba(168, 85, 247, 0.2);
            box-shadow: 0 0 15px 0 var(--neon-purple) inset, 0 0 20px 0 var(--neon-purple);
            color: white;
            transform: scale(1.05);
        }
        
        .ui-button:active {
            transform: scale(0.98);
        }

        .large-button {
            font-size: 1.2rem;
            padding: 15px 30px;
            margin: 20px 0;
        }

        .menu-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        /* Styly pro ikony v tlačítkách */
        .ui-button svg {
            width: 24px;
            height: 24px;
            fill: var(--neon-purple);
            transition: all 0.3s ease;
        }

        .ui-button:hover svg, .ui-button:focus svg {
            fill: white;
            filter: drop-shadow(0 0 5px white);
        }

        #pause-button {
            border-color: var(--neon-blue);
            box-shadow: 0 0 10px 0 var(--neon-blue) inset, 0 0 10px 0 var(--neon-blue);
        }
        #pause-button svg {
            fill: var(--neon-blue);
        }
        #pause-button:hover {
             background: rgba(0, 246, 255, 0.2);
             box-shadow: 0 0 15px 0 var(--neon-blue) inset, 0 0 20px 0 var(--neon-blue);
        }

        /* --- Zprávy ve hře --- */
        #message-display {
            position: absolute;
            bottom: 20%;
            left: 50%;
            transform: translateX(-50%);
            padding: 15px 25px;
            font-family: var(--font-header);
            font-size: 1.2rem;
            color: var(--neon-blue);
            text-shadow: 0 0 8px var(--neon-blue);
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 15px;
            backdrop-filter: blur(5px);
            opacity: 0;
            transition: opacity 0.5s ease, transform 0.5s ease;
            pointer-events: none;
            z-index: 50;
        }

        #message-display.show {
            opacity: 1;
            transform: translateX(-50%) translateY(-20px);
        }
    </style>
</head>
<body>
    <div id="game-container">
        <canvas id="game-canvas"></canvas>

        <div id="hud">
            <div class="hud-item score-container">
                <span id="score-icon"></span>
                <span id="score">0</span>
            </div>
            <div class="hud-item health-container">
                <span id="health-icon"></span>
                <span id="health">3</span>
            </div>
            <div class="hud-item-right">
                 <button id="pause-button" class="ui-button" aria-label="Pozastavit hru"></button>
            </div>
        </div>

        <div id="main-menu" class="glass-panel active">
            <h1 class="game-title">Piko Přepadení</h1>
            <p class="game-subtitle">Satirická jízda Prahou</p>
            <button id="start-game-button" class="ui-button large-button">
                <span id="play-icon-menu"></span>
                <span>Spustit Jízdu</span>
            </button>
            <div class="menu-buttons">
                <button id="leaderboard-button" class="ui-button" aria-label="Žebříček"></button>
                <button id="settings-button" class="ui-button" aria-label="Nastavení"></button>
            </div>
        </div>

        <div id="pause-menu" class="glass-panel">
            <h2 class="menu-title">Pauza</h2>
            <p>Dáváš si čouda?</p>
            <button id="resume-game-button" class="ui-button large-button">
                <span id="play-icon-pause"></span>
                <span>Pokračovat</span>
            </button>
            <button id="main-menu-button" class="ui-button">Zpět do Menu</button>
        </div>

        <div id="game-over-screen" class="glass-panel">
            <h2 class="menu-title">Chytli Tě!</h2>
            <p id="game-over-quote" class="quote-text">Příště běž jinudy!</p>
            <div class="score-summary">
                <p>Tvoje Skóre: <span id="final-score">0</span></p>
                <p>Nejlepší Jízda: <span id="high-score">0</span></p>
            </div>
            <button id="restart-game-button" class="ui-button large-button">
                 <span id="restart-icon-gameover"></span>
                <span>Zkusit Znovu</span>
            </button>
        </div>

        <div id="message-display" class="message"></div>
    </div>

    <script>
        // ===================================================================================
        // SCRIPT 1: UTILS.JS
        // ===================================================================================
        const Utils = {
            getRandomQuote(category) {
                if (Content && Content.quotes && Content.quotes[category]) {
                    const quotes = Content.quotes[category];
                    return quotes[Math.floor(Math.random() * quotes.length)];
                }
                return "Hláška nenalezena.";
            },
            saveData(key, value) {
                try {
                    localStorage.setItem(key, JSON.stringify(value));
                } catch (e) {
                    console.error("Chyba při ukládání dat do localStorage:", e);
                }
            },
            loadData(key, defaultValue) {
                try {
                    const value = localStorage.getItem(key);
                    return value ? JSON.parse(value) : defaultValue;
                } catch (e) {
                    console.error("Chyba při načítání dat z localStorage:", e);
                    return defaultValue;
                }
            },
            vibrate(pattern) {
                if ('vibrate' in navigator) {
                    try {
                        navigator.vibrate(pattern);
                    } catch (e) {
                        console.warn("Haptická odezva selhala:", e);
                    }
                }
            }
        };

        // ===================================================================================
        // SCRIPT 2: ASSETS.JS (s novými SVG pro herní objekty)
        // ===================================================================================
        const Assets = {
            icons: {
                play: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"></path></svg>`,
                pause: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"></path></svg>`,
                settings: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M19.43 12.98c.04-.32.07-.64.07-.98s-.03-.66-.07-.98l2.11-1.65c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.3-.61-.22l-2.49 1c-.52-.4-1.08-.73-1.69-.98l-.38-2.65C14.46 2.18 14.25 2 14 2h-4c-.25 0-.46.18-.49.42l-.38 2.65c-.61.25-1.17.59-1.69-.98l-2.49-1c-.23-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64l2.11 1.65c-.04.32-.07.65-.07.98s.03.66.07.98l-2.11 1.65c-.19.15-.24.42.12.64l2 3.46c.12.22.39.3.61.22l2.49-1c.52.4 1.08.73 1.69.98l.38 2.65c.03.24.24.42.49.42h4c.25 0 .46-.18.49-.42l.38-2.65c.61-.25 1.17-.59 1.69-.98l2.49 1c.23.09.49 0 .61-.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.65zM12 15.5c-1.93 0-3.5-1.57-3.5-3.5s1.57-3.5 3.5-3.5 3.5 1.57 3.5 3.5-1.57 3.5-3.5 3.5z"></path></svg>`,
                leaderboard: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M16 11V3H8v8H2v10h20V11h-6zm-6-6h4v14h-4V5zm-6 6h4v8H4v-8zm16 8h-4v-8h4v8z"></path></svg>`,
                
                // In-game icons pro HUD
                drug_pill: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M15.5 2.5A6.49 6.49 0 009 9v6a6.5 6.5 0 0013 0V9a6.49 6.49 0 00-6.5-6.5zM12 4h7a3.5 3.5 0 010 7h-7V4z"></path></svg>`,
                syringe: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" transform="rotate(45)"><path d="M19 3h-1V2h-2v1h-1c-1.1 0-2 .9-2 2v1H2v2h11v1c0 .83-.67 1.5-1.5 1.5H11v2h.5c.28 0 .5.22.5.5V16h-1v2h1v1h2v-1h1v-2h-1v-1.5c0-.28.22-.5.5-.5H13v-2h-.5c-.83 0-1.5-.67-1.5-1.5V9h7V7h-7V5c0-.55.45-1 1-1h1V2h2v1h1v2h-1v2h-2V5h-1c-.55 0-1 .45-1 1v1h2v2h-2v1.68c.84.32 1.5.98 1.5 1.82v2h2v-2h2v-2h-2v-2h-2V7h2V5h2V3z"></path></svg>`,

                // Nové in-game ikony
                player_piko_pete: `
                    <svg viewBox="0 0 50 80" xmlns="http://www.w3.org/2000/svg" fill="var(--neon-purple)">
                        <rect x="15" y="0" width="20" height="20" rx="10" ry="10" stroke="var(--neon-blue)" stroke-width="2"/> <rect x="10" y="20" width="30" height="30" rx="5" ry="5" stroke="var(--neon-blue)" stroke-width="2"/> <rect x="5" y="25" width="10" height="20" rx="3" ry="3" stroke="var(--neon-blue)" stroke-width="2"/> <rect x="35" y="25" width="10" height="20" rx="3" ry="3" stroke="var(--neon-blue)" stroke-width="2"/> <rect x="15" y="50" width="10" height="30" rx="3" ry="3" stroke="var(--neon-blue)" stroke-width="2"/> <rect x="25" y="50" width="10" height="30" rx="3" ry="3" stroke="var(--neon-blue)" stroke-width="2"/> </svg>`,

                lajna_matro: `
                    <svg viewBox="0 0 50 20" xmlns="http://www.w3.org/2000/svg" fill="white">
                        <path d="M5 10 H45" stroke="white" stroke-width="5" stroke-linecap="round"/>
                        <circle cx="5" cy="10" r="3" fill="var(--neon-blue)"/>
                        <circle cx="45" cy="10" r="3" fill="var(--neon-blue)"/>
                    </svg>`,

                cevko_syringe: `
                    <svg viewBox="0 0 30 60" xmlns="http://www.w3.org/2000/svg" fill="none" stroke="red" stroke-width="3">
                        <rect x="10" y="5" width="10" height="40" rx="5" ry="5" fill="rgba(255,0,0,0.5)"/>
                        <path d="M15 45 L15 55 M15 55 L10 50 M15 55 L20 50" stroke="red" stroke-linecap="round"/>
                    </svg>`,

                policajt_chase: `
                    <svg viewBox="0 0 50 60" xmlns="http://www.w3.org/2000/svg" fill="blue">
                        <rect x="15" y="0" width="20" height="20" rx="10" ry="10" stroke="var(--neon-blue)" stroke-width="2"/> <rect x="10" y="20" width="30" height="30" rx="5" ry="5" fill="darkblue" stroke="var(--neon-blue)" stroke-width="2"/> <circle cx="25" cy="35" r="8" fill="var(--neon-blue)"/> <path d="M10 25 L5 15 M40 25 L45 15" stroke="var(--neon-blue)" stroke-width="2" stroke-linecap="round"/> <path d="M15 50 L10 60 M35 50 L40 60" stroke="var(--neon-blue)" stroke-width="2" stroke-linecap="round"/> </svg>`,

                auto_prekazka: `
                    <svg viewBox="0 0 70 40" xmlns="http://www.w3.org/2000/svg" fill="gray">
                        <rect x="5" y="10" width="60" height="25" rx="5" ry="5" fill="darkslategray" stroke="var(--neon-blue)" stroke-width="2"/>
                        <rect x="15" y="5" width="40" height="10" rx="3" ry="3" fill="rgba(0,0,0,0.5)" stroke="var(--neon-blue)" stroke-width="2"/> <circle cx="15" cy="30" r="7" fill="black" stroke="var(--neon-blue)" stroke-width="2"/>
                        <circle cx="55" cy="30" r="7" fill="black" stroke="var(--neon-blue)" stroke-width="2"/>
                    </svg>`
            }
        };

        // ===================================================================================
        // SCRIPT 3: CONTENT.JS
        // ===================================================================================
        const Content = {
            quotes: {
                start: ["Jdeme na to, kámo!","Dneska to bude jízda!","Hlavně nenápadně...","Potřebuju na vlakáč!"],
                collect: ["Dobrý matroš!","Tohle zachrání večer!","Čistá práce!","Kvalitka z Dejvic."],
                health: ["Extra cévko se hodí!","Ještě nejsem na odpis!","Tohle mě postaví na nohy.","Zdravíčko!"],
                damage: ["Prásknul ses!","Tohle bolí víc než absťák!","Do prdele, fízlové!","Bacha, díra!"],
                gameOver: ["Chytli tě, šlehaři!","Příště běž jinudy!", "Konec jízdy, kámo.", "Game over, smažko."]
            }
        };

        // ===================================================================================
        // SCRIPT 4: AUDIOMANAGER.JS (NOVÝ SKRIPT)
        // ===================================================================================
        const AudioManager = {
            isInitialized: false,
            synth: null,
            noiseSynth: null,

            // Inicializuje Tone.js při první interakci uživatele
            async initialize() {
                if (this.isInitialized || typeof Tone === 'undefined') return;
                try {
                    await Tone.start();
                    this.synth = new Tone.Synth().toDestination();
                    this.noiseSynth = new Tone.NoiseSynth({
                        noise: { type: 'white' },
                        envelope: { attack: 0.005, decay: 0.1, sustain: 0 }
                    }).toDestination();
                    this.isInitialized = true;
                    console.log("Audio bylo úspěšně inicializováno.");
                } catch (e) {
                    console.error("Chyba při inicializaci audia:", e);
                }
            },

            playStart() {
                if (!this.isInitialized) return;
                this.synth.triggerAttackRelease("C4", "8n", Tone.now());
                this.synth.triggerAttackRelease("E4", "8n", Tone.now() + 0.1);
                this.synth.triggerAttackRelease("G4", "8n", Tone.now() + 0.2);
            },

            playCollect() {
                if (!this.isInitialized) return;
                this.synth.triggerAttackRelease("C6", "16n");
            },

            playHealth() {
                if (!this.isInitialized) return;
                this.synth.triggerAttackRelease("A5", "16n", Tone.now());
                this.synth.triggerAttackRelease("E6", "16n", Tone.now() + 0.1);
            },

            playDamage() {
                if (!this.isInitialized) return;
                this.noiseSynth.triggerAttackRelease("0.1");
                this.synth.triggerAttackRelease("A2", "8n");
            },

            playGameOver() {
                if (!this.isInitialized) return;
                this.synth.triggerAttackRelease("G3", "8n", Tone.now());
                this.synth.triggerAttackRelease("E3", "8n", Tone.now() + 0.2);
                this.synth.triggerAttackRelease("C3", "4n", Tone.now() + 0.4);
            }
        };


        // ===================================================================================
        // SCRIPT 5: GAME.JS (UPRAVENÝ)
        // ===================================================================================
        window.addEventListener('load', () => {
            const canvas = document.getElementById('game-canvas');
            const ctx = canvas.getContext('2d');
            const gameContainer = document.getElementById('game-container');
            const mainMenu = document.getElementById('main-menu');
            const pauseMenu = document.getElementById('pause-menu');
            const gameOverScreen = document.getElementById('game-over-screen');
            const hud = document.getElementById('hud');
            const startButton = document.getElementById('start-game-button');
            const pauseButton = document.getElementById('pause-button');
            const resumeButton = document.getElementById('resume-game-button');
            const restartButton = document.getElementById('restart-game-button');
            const toMenuButton = document.getElementById('main-menu-button');
            const scoreDisplay = document.getElementById('score');
            const healthDisplay = document.getElementById('health');
            const finalScoreDisplay = document.getElementById('final-score');
            const highScoreDisplay = document.getElementById('high-score');
            const gameOverQuoteDisplay = document.getElementById('game-over-quote');
            const messageDisplay = document.getElementById('message-display');
            
            let gameState = 'MENU';
            let score = 0;
            let health = 3;
            let highScore = Utils.loadData('pikoHeistHighScore', 0);
            let gameSpeed = 3;
            const initialGameSpeed = 3;
            const maxGameSpeed = 10;
            let animationFrameId;

            const player = {
                x: 0,
                y: 0,
                width: 50,
                height: 80,
                lane: 1,
                lanes: [],
                draw() {
                    const x = this.x;
                    const y = this.y;
                    drawSvg(ctx, Assets.icons.player_piko_pete, x, y, this.width, this.height, 'var(--neon-purple)');
                },
                update() {
                    this.lanes = [canvas.width / 4, canvas.width / 2, canvas.width * 3 / 4];
                    const targetX = this.lanes[this.lane];
                    const ease = 0.2;
                    this.x += (targetX - this.x) * ease;
                    this.draw();
                }
            };

            function drawSvg(ctx, svgString, x, y, width, height, glowColor = null) {
                const img = new Image();
                img.src = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svgString)));
                ctx.save();
                if (glowColor) {
                    ctx.shadowColor = glowColor;
                    ctx.shadowBlur = 10;
                }
                ctx.drawImage(img, x - width / 2, y - height, width, height);
                ctx.restore();
            }

            function resizeCanvas() {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
                if (player) {
                    player.y = canvas.height - 100;
                }
            }
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);

            function renderUIicons() {
                document.getElementById('score-icon').innerHTML = Assets.icons.drug_pill;
                document.getElementById('health-icon').innerHTML = Assets.icons.syringe;
                document.getElementById('pause-button').innerHTML = Assets.icons.pause;
                document.getElementById('play-icon-menu').innerHTML = Assets.icons.play;
                document.getElementById('play-icon-pause').innerHTML = Assets.icons.play;
                document.getElementById('restart-icon-gameover').innerHTML = Assets.icons.play;
                document.getElementById('leaderboard-button').innerHTML = Assets.icons.leaderboard;
                document.getElementById('settings-button').innerHTML = Assets.icons.settings;
            }
            
            let gameObjects = [];
            let roadLines = [];
            let cityBackground = [];

            function createRoadLine() {
                 roadLines.push({ y: -20, height: 40 });
            }

            function updateRoad() {
                ctx.strokeStyle = 'rgba(136, 146, 176, 0.3)';
                ctx.lineWidth = 2;
                roadLines.forEach((line, index) => {
                    line.y += gameSpeed * 0.8;
                    ctx.beginPath();
                    ctx.moveTo(canvas.width / 2, line.y);
                    ctx.lineTo(canvas.width / 2, line.y - line.height);
                    ctx.stroke();
                    if(line.y > canvas.height + line.height) roadLines.splice(index, 1);
                });
                if(roadLines.length < 20 && (!roadLines.length || roadLines[roadLines.length - 1]?.y > 80)) createRoadLine();
            }

            function createCityBackground() {
                const skylineSVG = `
                    <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg" fill="#303C55" stroke="rgba(0,0,0,0.1)">
                        <rect x="0" y="50" width="10" height="50"/> <rect x="15" y="40" width="10" height="60"/> <rect x="30" y="60" width="10" height="40"/> <rect x="45" y="30" width="10" height="70"/> <rect x="60" y="55" width="10" height="45"/> <rect x="75" y="45" width="10" height="55"/> <rect x="90" y="65" width="10" height="35"/> </svg>
                `;
                cityBackground.push({
                    y: -canvas.height * 2,
                    height: canvas.height * 2,
                    svg: skylineSVG,
                    xOffset: Math.random() * (canvas.width / 2) - (canvas.width / 4),
                    width: canvas.width
                });
            }

            function updateCityBackground() {
                ctx.globalAlpha = 0.2;
                cityBackground.forEach((bg, index) => {
                    bg.y += gameSpeed * 0.1;
                    drawSvg(ctx, bg.svg, canvas.width / 2 + bg.xOffset, bg.y, bg.width, bg.height, null);
                    if (bg.y > canvas.height + bg.height / 2) {
                        cityBackground.splice(index, 1);
                    }
                });
                ctx.globalAlpha = 1;

                if (cityBackground.length === 0 || cityBackground[cityBackground.length - 1].y > -canvas.height * 0.5) {
                    createCityBackground();
                }
            }

            function createGameObject() {
                const types = [
                    { type: 'lajna', svg: Assets.icons.lajna_matro, width: 50, height: 20, glow: 'white' },
                    { type: 'cevko', svg: Assets.icons.cevko_syringe, width: 30, height: 60, glow: 'red' },
                    { type: 'policajt', svg: Assets.icons.policajt_chase, width: 50, height: 60, glow: 'blue' },
                    { type: 'auto', svg: Assets.icons.auto_prekazka, width: 70, height: 40, glow: 'gray' }
                ];
                const typeObj = types[Math.floor(Math.random() * types.length)];
                const lane = Math.floor(Math.random() * 3);
                
                let newObject = {
                    type: typeObj.type,
                    svg: typeObj.svg,
                    y: -100,
                    width: typeObj.width,
                    height: typeObj.height,
                    lane: lane,
                    glowColor: typeObj.glow,
                    draw() {
                        const x = player.lanes[this.lane];
                        drawSvg(ctx, this.svg, x, this.y, this.width, this.height, this.glowColor);
                    },
                    update() {
                        this.y += gameSpeed;
                        this.draw();
                    },
                };
                gameObjects.push(newObject);
            }

            let gameObjectTimer = 0;
            
            function gameLoop() {
                if (gameState !== 'PLAYING') return;

                ctx.clearRect(0, 0, canvas.width, canvas.height);
                updateCityBackground();
                updateRoad();

                gameObjectTimer++;
                if (gameObjectTimer > 100 / (gameSpeed / initialGameSpeed)) {
                    createGameObject();
                    gameObjectTimer = 0;
                }

                gameObjects.forEach((obj, index) => {
                    obj.update();
                    if ( player.lane === obj.lane && obj.y + obj.height / 2 > player.y - player.height && obj.y - obj.height / 2 < player.y ) {
                        handleCollision(obj, index);
                    }
                    if (obj.y > canvas.height + obj.height) {
                        gameObjects.splice(index, 1);
                    }
                });
                
                player.update();
                
                gameSpeed = Math.min(maxGameSpeed, gameSpeed + 0.001);
                score += Math.floor(gameSpeed);
                updateHUD();

                animationFrameId = requestAnimationFrame(gameLoop);
            }

            function handleCollision(obj, index) {
                gameObjects.splice(index, 1);
                Utils.vibrate(50);
                switch (obj.type) {
                    case 'lajna': 
                        score += 1000; 
                        showMessage(Utils.getRandomQuote('collect'));
                        AudioManager.playCollect(); // ZVUK
                        break;
                    case 'cevko': 
                        health = Math.min(5, health + 1); 
                        showMessage(Utils.getRandomQuote('health'));
                        AudioManager.playHealth(); // ZVUK
                        break;
                    case 'policajt': 
                    case 'auto':
                        health--;
                        showMessage(Utils.getRandomQuote('damage'));
                        AudioManager.playDamage(); // ZVUK
                        if (health <= 0) endGame();
                        break;
                }
            }

            function updateHUD() {
                scoreDisplay.textContent = score;
                healthDisplay.textContent = health;
            }

            function showMessage(text) {
                messageDisplay.textContent = text;
                messageDisplay.classList.add('show');
                setTimeout(() => { messageDisplay.classList.remove('show'); }, 2000);
            }

            function resetGame() {
                score = 0;
                health = 3;
                gameSpeed = initialGameSpeed;
                player.x = canvas.width / 2;
                player.y = canvas.height - 100;
                player.lane = 1;
                gameObjects = [];
                roadLines = [];
                cityBackground = [];
                createRoadLine();
                createCityBackground();
                updateHUD();
            }

            function startGame() {
                AudioManager.initialize(); // Inicializace zvuku při startu
                resetGame();
                gameState = 'PLAYING';
                mainMenu.classList.remove('active');
                gameOverScreen.classList.remove('active');
                hud.style.display = 'flex';
                gameLoop();
                showMessage(Utils.getRandomQuote('start'));
                AudioManager.playStart(); // ZVUK
            }

            function pauseGame() {
                if (gameState !== 'PLAYING') return;
                gameState = 'PAUSED';
                cancelAnimationFrame(animationFrameId);
                pauseMenu.classList.add('active');
            }

            function resumeGame() {
                if (gameState !== 'PAUSED') return;
                gameState = 'PLAYING';
                pauseMenu.classList.remove('active');
                gameLoop();
            }

            function endGame() {
                gameState = 'GAMEOVER';
                cancelAnimationFrame(animationFrameId);
                Utils.vibrate([100, 50, 100]);
                AudioManager.playGameOver(); // ZVUK
                if (score > highScore) {
                    highScore = score;
                    Utils.saveData('pikoHeistHighScore', highScore);
                }
                finalScoreDisplay.textContent = score;
                highScoreDisplay.textContent = highScore;
                gameOverQuoteDisplay.textContent = Utils.getRandomQuote('gameOver');
                gameOverScreen.classList.add('active');
                hud.style.display = 'none';
            }

            function showMainMenu() {
                gameState = 'MENU';
                mainMenu.classList.add('active');
                pauseMenu.classList.remove('active');
                gameOverScreen.classList.remove('active');
                hud.style.display = 'none';
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            }

            let touchStartX = 0;
            let touchStartY = 0;
            function handleTouchStart(e) { touchStartX = e.touches[0].clientX; touchStartY = e.touches[0].clientY; }
            function handleTouchMove(e) {
                if (!touchStartX || !touchStartY || gameState !== 'PLAYING') return;
                let diffX = e.touches[0].clientX - touchStartX;
                if (Math.abs(diffX) > 30) {
                    if (diffX > 0) player.lane = Math.min(2, player.lane + 1);
                    else player.lane = Math.max(0, player.lane - 1);
                    touchStartX = 0; touchStartY = 0;
                }
            }
            function handleKeyDown(e) {
                if (gameState !== 'PLAYING') return;
                if (e.key === 'ArrowLeft' || e.key === 'a') player.lane = Math.max(0, player.lane - 1);
                else if (e.key === 'ArrowRight' || e.key === 'd') player.lane = Math.min(2, player.lane + 1);
            }

            startButton.addEventListener('click', startGame);
            pauseButton.addEventListener('click', pauseGame);
            resumeButton.addEventListener('click', resumeGame);
            restartButton.addEventListener('click', startGame);
            toMenuButton.addEventListener('click', showMainMenu);
            gameContainer.addEventListener('touchstart', handleTouchStart, { passive: true });
            gameContainer.addEventListener('touchmove', handleTouchMove, { passive: true });
            window.addEventListener('keydown', handleKeyDown);

            function init() {
                highScoreDisplay.textContent = highScore;
                renderUIicons();
                showMainMenu();
            }
            init();
        });

        // Register Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => console.log('Service Worker registered:', registration))
                    .catch(error => console.log('Service Worker registration failed:', error));
            });
        }
    </script>
</body>
</html>
